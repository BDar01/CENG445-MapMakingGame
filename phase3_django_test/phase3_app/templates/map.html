<!-- Add the jQuery library -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
{% load static %}
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome</title>
    <style>
        body {
            /* Set background color to contrast with the background */
            background-color: #f0f0f0;

            /* Set text color to contrast with the background */
            color: #ffffff;

            /* Remove default margin on the body */
            margin: 0;

            /* Set overflow to hidden to ensure background doesn't overflow */
            overflow: hidden;
        }

        text {
            font-size: 16px;
            color: #333333;
        }

        h1 {
            font-size: 24px;
            color: #333333;
        }

        #map-svg-container {
            /* Set the width and height of the container */
            width: 612px;
            height: 408px;

            /* Position the container relatively */
            position: relative;

            /* Ensure the container covers the entire viewport */
            margin: 50px auto;
            overflow: hidden; /* Hide overflow content */
        }

        #map-svg-container::before {
            /* Specify the URL of your background image */
            content: "";
            background-image: url('{% static "images/" %}{{background_image}}');

            /* Set background size to cover the entire container */
            background-size: cover;

            /* Set background position to center the image */
            background-position: center;

            /* Set the width and height of the container */
            width: 100%;
            height: 100%;

            /* Position the pseudo-element absolutely */
            position: absolute;

            /* Ensure the pseudo-element covers the entire container */
            top: 0;
            left: 0;
            z-index: -1; /* Place the pseudo-element behind other content */
        }

        #map-svg {
            /* Set the width and height to 100% to fill the container */
            width: 100%;
            height: 100%;
        }

        #map-svg text {
            font-size: 16px; /* Set the desired font size for text elements */
        }
    </style>       
</head>

<body>
    <h1>Welcome to map: {{map_id}} & team: {{teamname}}, player no: {{playername}}</h1>
    <h1 id="objects-data">Map Objects: {{objects}}</h1>
    <text><b> Player Objects: {{repo}}</b> </text><br>
    <text><b> Commands: </b></text> <button id="leavemap-btn">Leave Map</button> <text> Drop: </text> <button id="dropmine-btn">Mine</button> <button id="dropfrzr-btn">Freezer</button> <button id="drophlth-btn">Health</button><br>
    <text><b> Messages: </b> {{msg}} </text>
    <div id="map-svg-container">
        <svg id="map-svg">
            {% for obj in objects %}
            <text x="{{ obj.2 }}" y="{{ obj.3 }}" fill="red">{{ obj.1 }} {{obj.0}}</text>
            <circle cx="{{ obj.2 }}" cy="{{ obj.3 }}" r="5" fill="red"/>
            {% endfor %}
        </svg>
    </div>
</body>
</html>

<script>

    $(document).ready(function() {
        var background_image = "{{background_image}}";

        // Check the background_image value
        if (background_image === "BackgroundImage2.jpg") {
            // If it's "labyrinth", update the styles
            $("#map-svg-container").css({
                "width": "650px",
                "height": "490px"
            });

            // Update transform property for text and circle elements
            $("#map-svg text, #map-svg circle").each(function() {
                var x = parseFloat($(this).attr("x")) * 0.5;
                var y = parseFloat($(this).attr("y")) * 0.5;
                var cx = parseFloat($(this).attr("cx")) * 0.5;
                var cy = parseFloat($(this).attr("cy")) * 0.5;

                $(this).attr("x", x);
                $(this).attr("y", y);
                $(this).attr("cx", cx);
                $(this).attr("cy", cy);
            });

            $("#map-svg").css({
                "width": "100%",
                "height": "100%"
            });
        }
    });

    var leaveMapButton = document.getElementById("leavemap-btn")
    var dropMineButton = document.getElementById("dropmine-btn")
    var dropFreezerButton = document.getElementById("dropfrzr-btn")
    var dropHealthButton = document.getElementById("drophlth-btn")

    var mapId = "{{map_id}}"
    var teamName = "{{teamname}}"
    var playerName = "{{playername}}"
    leaveMapButton.addEventListener("click", function() {
        window.location.href = "{% url 'leave_map' %}?map_id="+ mapId + "&teamname=" + teamName;
    });

    dropMineButton.addEventListener("click", function() {
        $.ajax({
            url: "{% url 'drop_object' %}?map_id=" + mapId + "&teamname=" + teamName + "&playername=" + playerName + "&background_image={{background_image}}" + "&object=" + "Mine",
            type: 'GET',
            dataType: 'html',  // Expect HTML response
            success: function(data) {
                console.log("Value of msg:", "{{ msg }}");
                // On success, update the entire HTML content with the new data
                window.location.reload()
            },
            error: function(error) {
                console.error("Error moving player:", error);
            }
        })
    });
    
    dropFreezerButton.addEventListener("click", function() {
        $.ajax({
            url: "{% url 'drop_object' %}?map_id=" + mapId + "&teamname=" + teamName + "&playername=" + playerName + "&background_image={{background_image}}" + "&object=" + "Freezer",
            type: 'GET',
            dataType: 'html',  // Expect HTML response
            success: function(data) {
                console.log("Value of msg:", "{{ msg }}");
                // On success, update the entire HTML content with the new data
                window.location.reload()
            },
            error: function(error) {
                console.error("Error moving player:", error);
            }
        })
    });

    dropHealthButton.addEventListener("click", function() {
        $.ajax({
            url: "{% url 'drop_object' %}?map_id=" + mapId + "&teamname=" + teamName + "&playername=" + playerName + "&background_image={{background_image}}" + "&object=" + "Health",
            type: 'GET',
            dataType: 'html',  // Expect HTML response
            success: function(data) {
                console.log("Value of msg:", "{{ msg }}");
                // On success, update the entire HTML content with the new data
                window.location.reload()
            },
            error: function(error) {
                console.error("Error moving player:", error);
            }
        })
    });

    function movePlayer(direction) {
        $.ajax({
            url: "{% url 'move_player' %}?map_id=" + mapId + "&teamname=" + teamName + "&playername=" + playerName + "&background_image={{background_image}}" + "&direction=" + direction,
            type: 'GET',
            dataType: 'html',  // Expect HTML response
            success: function(data) {
                console.log("Received data:", data);
                // On success, update the entire HTML content with the new data
                window.location.reload()
            },
            error: function(error) {
                console.error("Error moving player:", error);
            }
        });
    }

    function updateMapContent() {
        $.ajax({
            url: "{% url 'update_map' %}?map_id=" + mapId + "&teamname=" + teamName + "&playername=" + playerName + "&background_image={{background_image}}",
            type: 'GET',
            dataType: 'html',  // Expect HTML response
            success: function(data) {
                // Reload the entire page with the updated content
                window.location.reload();
            },
            error: function(error) {
                console.error("Error fetching updated data:", error);
            }
        });
    }

    // Set an interval to periodically call the updateMapContent function (every 5 seconds in this example)
    setInterval(updateMapContent, 5000);

    // Capture arrow key events
    $(document).keydown(function(e) {
        switch (e.which) {
            case 37: // Left arrow key
                movePlayer('W');
                break;
            case 38: // Up arrow key
                movePlayer('S');
                break;
            case 39: // Right arrow key
                movePlayer('E');
                break;
            case 40: // Down arrow key
                movePlayer('N');
                break;
            default:
                return;
        }
        e.preventDefault();
    });
</script>
